// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// Smart Adaptive Plant Care - Prisma Schema
// =====================================================

model PlantType {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  thresholds Json     // { soil_min, soil_max, temp_min, temp_max, humidity_min, humidity_max, light_min, light_max }
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  detections      Detection[]
}

model PlantData {
  id                       Int      @id @default(autoincrement())
  commonName               String   @map("common_name")
  wateringAmountMl         Float?   @map("watering_amount_ml")
  wateringFrequencyDays    Int?     @map("watering_frequency_days")
  idealSunlightExposure    String?  @map("ideal_sunlight_exposure")
  idealRoomTemperatureC    Float?   @map("ideal_room_temperature_c")
  idealHumidityPercent     Float?   @map("ideal_humidity_percent")
  fertilizerType           String?  @map("fertilizer_type")
  idealFertilizerAmountMl  Float?   @map("ideal_fertilizer_amount_ml")
  idealSoilMoisturePercent Float?   @map("ideal_soil_moisture_percent")
  idealSoilType            String?  @map("ideal_soil_type")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  detections      Detection[]
}

model Image {
  id         String      @id @default(uuid())
  // Cloudinary fields
  publicId   String?     @map("public_id")    // Cloudinary public_id
  secureUrl  String?     @map("secure_url")   // HTTPS URL returned by Cloudinary (canonical)
  imageUrl   String?     // legacy / optional field (kept for compatibility)
  folder     String?     // Cloudinary folder/path (e.g., "plant-demo/device-abc/2025/10")
  width      Int?
  height     Int?
  format     String?
  bytes      Int?
  timestamp  DateTime    @default(now())
  metadata   Json?       // EXIF / custom tags returned by Cloudinary

  detections      Detection[]
  inferenceCache  InferenceCache?
  readings        Reading[]

  createdAt  DateTime @default(now())

  @@index([timestamp])
  @@index([publicId])
}

model Detection {
  id           String     @id @default(uuid())
  image        Image      @relation(fields: [imageId], references: [id], onDelete: Cascade)
  imageId      String
  plantType    PlantType? @relation(fields: [plantTypeId], references: [id])
  plantTypeId  Int?
  plantData    PlantData? @relation(fields: [plantDataId], references: [id])
  plantDataId  Int?

  label        String
  confidence   Float
  bbox         Json?
  dominant     Boolean    @default(false)
  createdAt    DateTime   @default(now())

  @@index([label])
  @@index([createdAt])
}

model Reading {
  id           String   @id @default(uuid())
  timestamp    DateTime @default(now())
  deviceId     String?                 // optional for single-device setup
  soilPct      Float?
  temperatureC Float?
  humidityPct  Float?
  lux          Float?
  imageId      String?
  image        Image?   @relation(fields: [imageId], references: [id])
  rawPayload   Json?

  @@index([timestamp])
  @@index([deviceId])
}

/// Cache the raw YOLO/provider response for a given Image.
/// This prevents repeated calls to the YOLO provider for the same image.
model InferenceCache {
  id           String   @id @default(uuid())
  image        Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  imageId      String   @unique
  provider     String   // e.g., "HuggingFace"
  responseJson Json     // raw provider response (store as JSON)
  createdAt    DateTime @default(now())

  @@index([provider, createdAt])
}

/// Queue commands for Raspberry Pi devices (e.g., water pump activation)
model Command {
  id          String   @id @default(uuid())
  deviceId    String   @map("device_id")
  type        String   // "water", "calibrate", etc.
  payload     Json?    // Command-specific data (e.g., { duration: 5 })
  status      String   @default("pending") // "pending", "completed", "failed", "cancelled"
  result      Json?    // Result data from device execution
  createdAt   DateTime @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")
  error       String?  // Error message if failed

  @@index([deviceId, status])
  @@index([createdAt])
}
